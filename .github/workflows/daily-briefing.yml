name: Daily Briefing Update

on:
  # ë§¤ì¼ í•œêµ­ ì‹œê°„ ì˜¤ì „ 9ì‹œ ìë™ ì‹¤í–‰ (UTC 00:00)
  schedule:
    - cron: '0 0 * * *'
  
  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:

permissions:
  contents: write

env:
  NODE_VERSION: '20'

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Initialize database
        run: node scripts/init-db.js
      
      - name: Generate briefing data
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "ğŸ¤– Generating daily briefing..."
          node scripts/generate-briefing.js
          
          # ìƒì„±ëœ ë°ì´í„° í™•ì¸
          if [ -f "public/data/briefing.json" ]; then
            echo "âœ… Briefing data generated successfully"
            ls -lh public/data/briefing.json
          else
            echo "âŒ Failed to generate briefing data"
            exit 1
          fi
      
      - name: Organize data files
        run: |
          # í•œêµ­ ì‹œê°„ ê¸°ì¤€ ë‚ ì§œ
          DATE=$(TZ=Asia/Seoul date +%Y-%m-%d)
          YEAR=$(TZ=Asia/Seoul date +%Y)
          MONTH=$(TZ=Asia/Seoul date +%m)
          DAY=$(TZ=Asia/Seoul date +%d)
          
          echo "ğŸ“… Processing date: $DATE"
          
          # ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p public/data/$YEAR/$MONTH
          
          # ë‚ ì§œë³„ íŒŒì¼ ì €ì¥
          cp public/data/briefing.json public/data/$YEAR/$MONTH/$DAY.json
          echo "âœ… Created: public/data/$YEAR/$MONTH/$DAY.json"
          
          # latest.json ì—…ë°ì´íŠ¸
          cp public/data/briefing.json public/data/latest.json
          echo "âœ… Updated: public/data/latest.json"
          
          # dates.json ìƒì„± (ëª¨ë“  ë‚ ì§œ ëª©ë¡)
          echo "ğŸ“ Generating dates.json..."
          echo '{"dates":[' > public/data/dates.json
          find public/data -type f -name "*.json" -path "*/[0-9][0-9][0-9][0-9]/[0-9][0-9]/*.json" | \
            sed 's|public/data/\([0-9]\{4\}\)/\([0-9]\{2\}\)/\([0-9]\{2\}\)\.json|\1-\2-\3|' | \
            sort -r | \
            sed 's/.*/"&"/' | \
            paste -sd ',' - >> public/data/dates.json
          echo ']}' >> public/data/dates.json
          
          # íŒŒì¼ í¬ê¸° í™•ì¸
          echo "ğŸ“Š File sizes:"
          ls -lh public/data/latest.json
          ls -lh public/data/dates.json
          ls -lh public/data/$YEAR/$MONTH/$DAY.json
          
          # dates.json ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°
          echo "ğŸ“‹ dates.json preview:"
          head -n 5 public/data/dates.json
      
      - name: Commit and push
        run: |
          DATE=$(TZ=Asia/Seoul date +%Y-%m-%d)
          
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add public/data/
          
          # ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No changes to commit"
          else
            git commit -m "chore: update daily briefing [$DATE]"
            git push
            echo "âœ… Successfully pushed to GitHub"
            echo "ğŸ“… Date: $DATE"
            echo "ğŸ”— Data URL: https://raw.githubusercontent.com/${{ github.repository }}/main/public/data/latest.json"
          fi
